# File: docker-compose.gateway.yml
# API Gateway với Load Balancing (3 instances + Nginx)
# 
# ⚠️ DEPRECATED: File này đã được gộp vào docker-compose.dev.yml và docker-compose.prod.yml
# 
# KHUYẾN NGHỊ: Sử dụng file mới thay vì file này:
#   - Development: docker-compose -f docker-compose.dev.yml up -d
#   - Production:  docker-compose -f docker-compose.prod.yml up -d
#
# File này vẫn giữ lại để:
#   - Chạy riêng API Gateway khi cần debug
#   - Reference cho cấu trúc
#   - CI/CD riêng từng module
#
# ⚠️ QUAN TRỌNG: Cần chạy dependencies trước!
# 1. docker-compose -f docker-compose.network.yml up -d
# 2. docker-compose -f docker-compose.services.yml up -d  (để có postgres, redis)
# 3. docker-compose -f docker-compose.gateway.yml up -d
#
# Hoặc chạy tất cả cùng lúc (KHUYẾN NGHỊ):
# docker-compose -f docker-compose.network.yml -f docker-compose.services.yml -f docker-compose.gateway.yml -f docker-compose.monitoring.yml up -d
#
# Lưu ý khi down:
# - File này dùng external network, nên down sẽ không ảnh hưởng đến network
# - Để down hoàn toàn, nên down tất cả files cùng lúc

version: '3.8'

networks:
  ibn-network:
    external: true
    name: ibn-network

volumes:
  # Gateway-specific volumes (nếu cần riêng)
  # Note: Gateway có thể dùng chung postgres/redis từ services.yml
  gateway_nginx_logs:

services:
  # ============================================
  # API GATEWAY - LOAD BALANCED SETUP
  # ============================================
  
  # API Gateway Instance 1 (kết nối peer0)
  api-gateway-1:
    container_name: api-gateway-1
    build:
      context: ./api-gateway
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    environment:
      # Server
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8080
      GATEWAY_ENV: production

      # Database (dùng chung postgres từ services.yml)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ibn_gateway
      POSTGRES_MAX_OPEN_CONNS: 25
      POSTGRES_MAX_IDLE_CONNS: 10
      POSTGRES_CONN_MAX_LIFETIME: 5m
      POSTGRES_CONN_MAX_IDLE_TIME: 5m

      # Redis (dùng chung redis từ services.yml)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_DB: 0

      # Fabric Network - Peer 0
      FABRIC_CHANNEL: ibnchannel
      FABRIC_CHAINCODE: teaTraceCC
      FABRIC_MSP_ID: Org1MSP
      FABRIC_PEER_ENDPOINT: peer0.org1.ibn.vn:7051
      FABRIC_PEER_HOST_OVERRIDE: peer0.org1.ibn.vn
      FABRIC_USER_CERT_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
      FABRIC_USER_KEY_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/keystore
      FABRIC_PEER_TLS_CA_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/peers/peer0.org1.ibn.vn/tls/ca.crt

      # JWT
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}
      JWT_EXPIRY: 24h
      JWT_ISSUER: ibn-api-gateway

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_WINDOW: 1h

      # Circuit Breaker
      CIRCUIT_BREAKER_MAX_REQUESTS: 3
      CIRCUIT_BREAKER_INTERVAL: 10s
      CIRCUIT_BREAKER_TIMEOUT: 60s
      CIRCUIT_BREAKER_FAILURE_RATIO: 0.6

      # Logging
      LOG_LEVEL: info
      LOG_FORMAT: json
      LOG_OUTPUT: stdout

      # CORS
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "Accept,Authorization,Content-Type,X-CSRF-Token,X-API-Key"
      CORS_EXPOSED_HEADERS: "Link"
      CORS_MAX_AGE: 300
      CORS_ALLOW_CREDENTIALS: "true"
    ports:
      - "8084:8080"  # Expose riêng để debug (changed from 8081 to avoid conflict with cadvisor)
    volumes:
      - ./core/organizations:/app/organizations:ro
    networks:
      - ibn-network
    # Note: depends_on đã bỏ vì peer0.org1.ibn.vn được định nghĩa trong docker-compose.network.yml
    # Khi chạy riêng file này, cần chạy network.yml và services.yml trước
    # Hoặc chạy tất cả files cùng lúc: docker-compose -f docker-compose.network.yml -f docker-compose.services.yml -f docker-compose.gateway.yml up -d
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway Instance 2 (kết nối peer1)
  api-gateway-2:
    container_name: api-gateway-2
    build:
      context: ./api-gateway
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    environment:
      # Server
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8080
      GATEWAY_ENV: production

      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ibn_gateway
      POSTGRES_MAX_OPEN_CONNS: 25
      POSTGRES_MAX_IDLE_CONNS: 10
      POSTGRES_CONN_MAX_LIFETIME: 5m
      POSTGRES_CONN_MAX_IDLE_TIME: 5m

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_DB: 0

      # Fabric Network - Peer 1
      FABRIC_CHANNEL: ibnchannel
      FABRIC_CHAINCODE: teaTraceCC
      FABRIC_MSP_ID: Org1MSP
      FABRIC_PEER_ENDPOINT: peer1.org1.ibn.vn:8051
      FABRIC_PEER_HOST_OVERRIDE: peer1.org1.ibn.vn
      FABRIC_USER_CERT_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
      FABRIC_USER_KEY_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/keystore
      FABRIC_PEER_TLS_CA_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/peers/peer1.org1.ibn.vn/tls/ca.crt

      # JWT
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}
      JWT_EXPIRY: 24h
      JWT_ISSUER: ibn-api-gateway

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_WINDOW: 1h

      # Circuit Breaker
      CIRCUIT_BREAKER_MAX_REQUESTS: 3
      CIRCUIT_BREAKER_INTERVAL: 10s
      CIRCUIT_BREAKER_TIMEOUT: 60s
      CIRCUIT_BREAKER_FAILURE_RATIO: 0.6

      # Logging
      LOG_LEVEL: info
      LOG_FORMAT: json
      LOG_OUTPUT: stdout

      # CORS
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "Accept,Authorization,Content-Type,X-CSRF-Token,X-API-Key"
      CORS_EXPOSED_HEADERS: "Link"
      CORS_MAX_AGE: 300
      CORS_ALLOW_CREDENTIALS: "true"
    ports:
      - "8082:8080"  # Expose riêng để debug (optional)
    volumes:
      - ./core/organizations:/app/organizations:ro
    networks:
      - ibn-network
    # Note: depends_on đã bỏ vì postgres, redis, peer1 được định nghĩa trong files khác
    # Khi chạy riêng file này, cần chạy network.yml và services.yml trước
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # API Gateway Instance 3 (kết nối peer2)
  api-gateway-3:
    container_name: api-gateway-3
    build:
      context: ./api-gateway
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    environment:
      # Server
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8080
      GATEWAY_ENV: production

      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: ibn_gateway
      POSTGRES_MAX_OPEN_CONNS: 25
      POSTGRES_MAX_IDLE_CONNS: 10
      POSTGRES_CONN_MAX_LIFETIME: 5m
      POSTGRES_CONN_MAX_IDLE_TIME: 5m

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_DB: 0

      # Fabric Network - Peer 2
      FABRIC_CHANNEL: ibnchannel
      FABRIC_CHAINCODE: teaTraceCC
      FABRIC_MSP_ID: Org1MSP
      FABRIC_PEER_ENDPOINT: peer2.org1.ibn.vn:9051
      FABRIC_PEER_HOST_OVERRIDE: peer2.org1.ibn.vn
      FABRIC_USER_CERT_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
      FABRIC_USER_KEY_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/keystore
      FABRIC_PEER_TLS_CA_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/peers/peer2.org1.ibn.vn/tls/ca.crt

      # JWT
      JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}
      JWT_EXPIRY: 24h
      JWT_ISSUER: ibn-api-gateway

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_WINDOW: 1h

      # Circuit Breaker
      CIRCUIT_BREAKER_MAX_REQUESTS: 3
      CIRCUIT_BREAKER_INTERVAL: 10s
      CIRCUIT_BREAKER_TIMEOUT: 60s
      CIRCUIT_BREAKER_FAILURE_RATIO: 0.6

      # Logging
      LOG_LEVEL: info
      LOG_FORMAT: json
      LOG_OUTPUT: stdout

      # CORS
      CORS_ALLOWED_ORIGINS: "*"
      CORS_ALLOWED_METHODS: "GET,POST,PUT,PATCH,DELETE,OPTIONS"
      CORS_ALLOWED_HEADERS: "Accept,Authorization,Content-Type,X-CSRF-Token,X-API-Key"
      CORS_EXPOSED_HEADERS: "Link"
      CORS_MAX_AGE: 300
      CORS_ALLOW_CREDENTIALS: "true"
    ports:
      - "8083:8080"  # Expose riêng để debug (optional)
    volumes:
      - ./core/organizations:/app/organizations:ro
    networks:
      - ibn-network
    # Note: depends_on đã bỏ vì postgres, redis, peer2 được định nghĩa trong files khác
    # Khi chạy riêng file này, cần chạy network.yml và services.yml trước
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Load Balancer
  api-gateway-nginx:
    container_name: api-gateway-nginx
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./api-gateway/docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - gateway_nginx_logs:/var/log/nginx
    ports:
      - "8085:80"  # Main gateway port (load balanced) - changed from 8080 to avoid conflict with keycloak
    networks:
      - ibn-network
    depends_on:
      api-gateway-1:
        condition: service_healthy
      api-gateway-2:
        condition: service_healthy
      api-gateway-3:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

