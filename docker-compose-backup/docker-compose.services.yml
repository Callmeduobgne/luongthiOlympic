# File: docker-compose.services.yml
# Backend Infrastructure + Application Services
# 
# ⚠️ DEPRECATED: File này đã được gộp vào docker-compose.dev.yml và docker-compose.prod.yml
# 
# KHUYẾN NGHỊ: Sử dụng file mới thay vì file này:
#   - Development: docker-compose -f docker-compose.dev.yml up -d
#   - Production:  docker-compose -f docker-compose.prod.yml up -d
#
# File này vẫn giữ lại để:
#   - Chạy riêng services khi cần debug
#   - Reference cho cấu trúc
#   - CI/CD riêng từng module
#
# Usage (legacy): docker-compose -f docker-compose.services.yml up -d
# Note: Requires docker-compose.network.yml to be running first
#
# Lưu ý khi down:
# - File này dùng external network, nên down sẽ không ảnh hưởng đến network
# - Để down hoàn toàn, nên down tất cả files cùng lúc

version: '3.8'

networks:
  ibn-network:
    external: true
    name: ibn-network

volumes:
  # Backend volumes
  postgres_data:
  redis_data:
  keycloak_data:
  opa_data:
  
  # Development volumes
  frontend_node_modules:
  backend_go_modules:

services:
  # ============================================
  # BACKEND INFRASTRUCTURE
  # ============================================

  # PostgreSQL Database
  postgres:
    container_name: ibn-postgres
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ibn_gateway
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - 5432:5432
    networks:
      - ibn-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gateway -d ibn_gateway"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache
  redis:
    container_name: ibn-redis
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - 6379:6379
    networks:
      - ibn-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================
  # KEYCLOAK - IDENTITY PROVIDER
  # ============================================
  
  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:23.0
    environment:
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloakpw}
      - KC_DB_SCHEMA=public
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    command: start-dev
    ports:
      - "8080:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - ibn-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n' >&3 && cat <&3 | grep -q 'HTTP/1.1 200' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Open Policy Agent (OPA)
  opa:
    container_name: opa
    image: openpolicyagent/opa:latest
    environment:
      - OPA_LOG_LEVEL=info
      - OPA_LOG_FORMAT=json
    ports:
      - "8181:8181"
    volumes:
      - ./backend/policies:/policies:ro
      - opa_data:/data
    networks:
      - ibn-network
    command:
      - "run"
      - "--server"
      - "--addr=:8181"
      - "--log-level=info"
      - "--log-format=json"
      - "/policies"
    healthcheck:
      test: ["CMD", "/opa", "eval", "true"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ============================================
  # APPLICATION SERVICES
  # ============================================

  # IBN Backend API
  ibn-backend:
    container_name: ibn-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      # Server
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      ENV: production

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gateway
      DB_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      DB_NAME: ibn_gateway
      DB_SSLMODE: disable
      DB_MIN_CONNS: 5
      DB_MAX_CONNS: 25
      DB_IDLE_TIMEOUT: 5m
      DB_MAX_LIFETIME: 1h

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_DB: 0

      # Fabric
      FABRIC_MSP_ID: Org1MSP
      FABRIC_CRYPTO_PATH: /fabric/organizations
      FABRIC_CERT_PATH: /fabric/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
      FABRIC_KEY_PATH: ""
      FABRIC_TLS_CERT_PATH: ""
      FABRIC_PEER_ENDPOINT: peer0.org1.ibn.vn:7051
      FABRIC_GATEWAY_PEER: peer0.org1.ibn.vn
      FABRIC_CHANNEL_NAME: ibnchannel

      # JWT (Legacy - for backward compatibility)
      JWT_SECRET: ${JWT_SECRET:-ibn-network-production-secret-2024-change-this}
      JWT_ISSUER: ibn-network
      JWT_ACCESS_TTL: 15m
      JWT_REFRESH_TTL: 168h

      # Keycloak OAuth 2.0 / OIDC
      KEYCLOAK_ENABLED: "true"
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: ibn-network
      KEYCLOAK_CLIENT_ID: ibn-backend
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-aa7f16cc62f83c8c55cd453ae82fe448781a32cff5d29f6f9ef323c7483ead03}

      # Open Policy Agent (OPA)
      OPA_ENABLED: "true"
      OPA_BASE_URL: http://opa:8181

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_BURST: 50

      # Circuit Breaker
      CB_MAX_REQUESTS: 3
      CB_INTERVAL: 10s
      CB_TIMEOUT: 60s
      CB_FAILURE_RATIO: 0.6

      # Logging
      LOG_LEVEL: info
      LOG_FORMAT: json

      # OpenTelemetry
      OTEL_ENABLED: "false"
    volumes:
      - ./core/organizations:/fabric/organizations:ro
    ports:
      - 9090:8080
    networks:
      - ibn-network
    # Note: depends_on đã bỏ peer0 vì được định nghĩa trong docker-compose.network.yml
    # Khi chạy riêng file này, cần chạy network.yml trước
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # ============================================
  # API GATEWAY
  # ============================================
  # 
  # NOTE: API Gateway đã được tách ra file riêng:
  # - docker-compose.gateway.yml: Load balanced setup (3 instances + Nginx)
  # 
  # Để sử dụng gateway đơn (không load balancing), uncomment phần dưới:
  #
  # api-gateway:
  #   container_name: api-gateway
  #   build:
  #     context: ./api-gateway
  #     dockerfile: docker/Dockerfile
  #   environment:
  #     GATEWAY_HOST: 0.0.0.0
  #     GATEWAY_PORT: 8080
  #     GATEWAY_ENV: production
  #     POSTGRES_HOST: postgres
  #     POSTGRES_PORT: 5432
  #     POSTGRES_USER: gateway
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
  #     POSTGRES_DB: ibn_gateway
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
  #     FABRIC_CHANNEL: ibnchannel
  #     FABRIC_CHAINCODE: teaTraceCC
  #     FABRIC_MSP_ID: Org1MSP
  #     FABRIC_PEER_ENDPOINT: peer0.org1.ibn.vn:7051
  #     FABRIC_PEER_HOST_OVERRIDE: peer0.org1.ibn.vn
  #     FABRIC_USER_CERT_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
  #     FABRIC_USER_KEY_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/keystore
  #     FABRIC_PEER_TLS_CA_PATH: /app/organizations/peerOrganizations/org1.ibn.vn/peers/peer0.org1.ibn.vn/tls/ca.crt
  #     JWT_SECRET: ${JWT_SECRET:-your-super-secret-jwt-key-change-this-in-production-min-32-chars}
  #     JWT_EXPIRY: 24h
  #     JWT_ISSUER: ibn-api-gateway
  #   ports:
  #     - "8082:8080"
  #   volumes:
  #     - ./core/organizations:/app/organizations:ro
  #   networks:
  #     - ibn-network
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     redis:
  #       condition: service_healthy
  #     peer0.org1.ibn.vn:
  #       condition: service_started
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s
  #       restart: unless-stopped

  # Backend Development với Hot Reload (Air)
  backend-dev:
    container_name: ibn-backend-dev
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    environment:
      # Server
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 8080
      ENV: development

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: gateway
      DB_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      DB_NAME: ibn_gateway
      DB_SSLMODE: disable
      DB_MIN_CONNS: 5
      DB_MAX_CONNS: 25
      DB_IDLE_TIMEOUT: 5m
      DB_MAX_LIFETIME: 1h

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_DB: 0

      # Fabric
      FABRIC_MSP_ID: Org1MSP
      FABRIC_CRYPTO_PATH: /fabric/organizations
      FABRIC_CERT_PATH: /fabric/organizations/peerOrganizations/org1.ibn.vn/users/Admin@org1.ibn.vn/msp/signcerts/Admin@org1.ibn.vn-cert.pem
      FABRIC_KEY_PATH: ""
      FABRIC_TLS_CERT_PATH: ""
      FABRIC_PEER_ENDPOINT: peer0.org1.ibn.vn:7051
      FABRIC_GATEWAY_PEER: peer0.org1.ibn.vn
      FABRIC_CHANNEL_NAME: ibnchannel

      # JWT (Legacy - for backward compatibility)
      JWT_SECRET: ${JWT_SECRET:-ibn-network-production-secret-2024-change-this}
      JWT_ISSUER: ibn-network
      JWT_ACCESS_TTL: 15m
      JWT_REFRESH_TTL: 168h

      # Keycloak OAuth 2.0 / OIDC
      KEYCLOAK_ENABLED: "true"
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: ibn-network
      KEYCLOAK_CLIENT_ID: ibn-backend
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-aa7f16cc62f83c8c55cd453ae82fe448781a32cff5d29f6f9ef323c7483ead03}

      # Open Policy Agent (OPA)
      OPA_ENABLED: "true"
      OPA_BASE_URL: http://opa:8181

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_BURST: 50

      # Circuit Breaker
      CB_MAX_REQUESTS: 3
      CB_INTERVAL: 10s
      CB_TIMEOUT: 60s
      CB_FAILURE_RATIO: 0.6

      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: json

      # OpenTelemetry
      OTEL_ENABLED: "false"
    ports:
      - "9091:8080"  # Dev port (khác với production 9090)
    volumes:
      # Mount source code để hot reload
      - ./backend:/app
      # Cache go modules
      - backend_go_modules:/go/pkg/mod
      - ./core/organizations:/fabric/organizations:ro
    networks:
      - ibn-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    profiles:
      - dev  # Chỉ chạy khi dùng profile dev

  # ============================================
  # FRONTEND APPLICATION
  # ============================================
  
  # Frontend Production (Nginx)
  frontend:
    container_name: ibn-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3001:80"  # Changed from 3000 to avoid conflict with Grafana
    networks:
      - ibn-network
    # Note: depends_on đã bỏ api-gateway-nginx vì được định nghĩa trong docker-compose.gateway.yml
    # Khi chạy riêng file này, cần chạy gateway.yml trước
    # Hoặc chạy tất cả files cùng lúc
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Frontend Development với Hot Reload
  frontend-dev:
    container_name: ibn-frontend-dev
    image: node:20-alpine
    working_dir: /app
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=http://api-gateway-nginx:80
    ports:
      - "5173:5173"  # Vite dev server port
    volumes:
      # Mount source code để hot reload
      - ./frontend:/app
      # Cache node_modules để không cần install lại mỗi lần
      - frontend_node_modules:/app/node_modules
    networks:
      - ibn-network
    # Note: depends_on đã bỏ api-gateway-nginx vì được định nghĩa trong docker-compose.gateway.yml
    # Khi chạy riêng file này, cần chạy gateway.yml trước
    # Hoặc chạy tất cả files cùng lúc
    command: sh -c "if [ ! -d node_modules ] || [ package.json -nt node_modules ]; then npm install; fi && npm run dev"
    restart: unless-stopped
    profiles:
      - dev  # Chỉ chạy khi dùng profile dev

