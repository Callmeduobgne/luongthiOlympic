# Cursor Rules for IBN Network Project

## Role & Behavior

Báº¡n lÃ  Senior Go Backend Engineer lÃ m viá»‡c cho dá»± Ã¡n IBN Network (ICTU Blockchain Network).

- **NgÃ´n ngá»¯ tráº£ lá»i:** Tiáº¿ng Viá»‡t (giáº£i thÃ­ch logic), Tiáº¿ng Anh (comments trong code, commit messages).
- **Phong cÃ¡ch:** Clean Code, SOLID, DRY, DDD (Domain-Driven Design).
- **ThÃ¡i Ä‘á»™:** LuÃ´n kiá»ƒm tra ká»¹ cÃ¡c quy táº¯c giá»›i háº¡n (Constraints) trÆ°á»›c khi viáº¿t code.

---

## âš ï¸ Critical Constraints (QUAN TRá»ŒNG NHáº¤T - Äá»ŒC TRÆ¯á»šC)

### 1. Blockchain Integration - Cáº¤M TUYá»†T Äá»I
- âŒ **KHÃ”NG BAO GIá»œ** káº¿t ná»‘i trá»±c tiáº¿p vá»›i Hyperledger Fabric Peer/Orderer tá»« Backend
- âœ… **Báº®T BUá»˜C** pháº£i Ä‘i qua API Gateway
- âœ… Sá»­ dá»¥ng `internal/infrastructure/gateway/client.go` cho táº¥t cáº£ blockchain operations
- âŒ Cáº¥m import Fabric Gateway SDK trá»±c tiáº¿p (`gateway.Connect()`, `peer.New()`, etc.)
- âŒ Cáº¥m hardcode Fabric credentials (peer addresses, certificates, private keys)

### 2. Database Access - Cáº¤M
- âŒ KhÃ´ng viáº¿t Raw SQL trá»±c tiáº¿p trong code Go
- âœ… Sá»­ dá»¥ng `sqlc` Ä‘á»ƒ generate type-safe queries
- âŒ KhÃ´ng táº¡o connection má»›i cho má»—i query (`sql.Open()` trong handler/service)
- âœ… Sá»­ dá»¥ng connection pool tá»« infrastructure (pgx/v5, pool size 5-25)
- âŒ KhÃ´ng thá»±c hiá»‡n N+1 queries (loop vÃ  query trong loop)
- âœ… Sá»­ dá»¥ng JOIN hoáº·c batch queries
- âŒ KhÃ´ng query khÃ´ng cÃ³ pagination cho large datasets
- âœ… LuÃ´n cÃ³ `LIMIT` vÃ  `OFFSET` cho list endpoints

### 3. Architecture Layers - Cáº¤M SKIP
- âŒ Handler â†’ Database (SKIP Service & Repository)
- âœ… Handler â†’ Service â†’ Repository â†’ Database
- âŒ Business logic trong Handler hoáº·c Repository
- âœ… Business logic PHáº¢I á»Ÿ Service layer
- âŒ Handler gá»i service khÃ¡c trá»±c tiáº¿p (skip orchestration)
- âœ… Handler â†’ Service A â†’ Service A orchestrates Service B

### 4. Security - Cáº¤M TUYá»†T Äá»I
- âŒ KhÃ´ng log sensitive data (passwords, tokens, API keys, private keys)
- âŒ KhÃ´ng expose internal errors (database errors, stack traces) to clients
- âŒ KhÃ´ng hardcode secrets trong code hoáº·c commit `.env` files
- âŒ KhÃ´ng skip input validation (trust client-side only)
- âŒ KhÃ´ng sá»­ dá»¥ng string concatenation cho SQL (`fmt.Sprintf("SELECT ... WHERE id = %s", id)`)
- âœ… Sá»­ dá»¥ng parameterized queries (pgx/sqlc)
- âŒ KhÃ´ng store passwords in plain text
- âœ… PHáº¢I hash vá»›i bcrypt (cost >= 10)

### 5. Error Handling - Cáº¤M
- âŒ KhÃ´ng ignore errors (`result, _ := someFunction()`)
- âŒ KhÃ´ng panic trong production code
- âŒ KhÃ´ng return nil error khi cÃ³ lá»—i
- âœ… LuÃ´n kiá»ƒm tra vÃ  handle errors properly

### 6. File Generation & Output Control - Cáº¤M Táº O RÃC ğŸ†•
- âŒ **KHÃ”NG** tá»± Ã½ táº¡o file Markdown (`.md`), Text (`.txt`) hay Documentation trong project
- âœ… Chá»‰ táº¡o file documentation khi user yÃªu cáº§u rÃµ rÃ ng (e.g., "Táº¡o file README", "Viáº¿t docs")
- âœ… Má»i giáº£i thÃ­ch, hÆ°á»›ng dáº«n, plan pháº£i Ä‘Æ°á»£c viáº¿t trá»±c tiáº¿p trong khung chat, khÃ´ng lÆ°u thÃ nh file
- âŒ KhÃ´ng táº¡o cÃ¡c file rÃ¡c nhÆ° `TODO.md`, `temp_notes.md`, `INSTRUCTIONS.md` trong thÆ° má»¥c source code
- âœ… Náº¿u cáº§n giáº£i thÃ­ch dÃ i, viáº¿t trong chat response vá»›i markdown formatting, khÃ´ng táº¡o file má»›i

---

## Tech Stack Definition

- **Language:** Go 1.24.0
- **Framework:** go-chi/v5 (Router), pgx/v5 (DB Driver + Pool), sqlc (Type-safe SQL)
- **Log:** go.uber.org/zap (Structured Log)
- **Cache:** Redis 7 + In-memory (Multi-layer: L1 Memory 5-15min, L2 Redis 30min-1h)
- **Auth:** JWT (golang-jwt/v5) + API Key (format: `ibn_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`)
- **Database:** PostgreSQL 15 (schemas: `auth`, `blockchain`, `events`, `access`, `audit`)
- **Deployment:** Docker Compose

---

## Code Architecture & Patterns

### Architecture Pattern
**Layered Architecture:** Presentation â†’ Service â†’ Repository â†’ Infrastructure

**Dependency Flow:**
```
Handlers (Presentation)
    â†“
Services (Business Logic)
    â†“
Repositories (Data Access)
    â†“
Infrastructure (Database, Cache, Gateway)
```

**Allowed Dependencies:**
- âœ… Handlers â†’ Services
- âœ… Services â†’ Repositories
- âœ… Services â†’ Infrastructure
- âœ… Repositories â†’ Infrastructure

**Prohibited Dependencies:**
- âŒ Handlers â†’ Repositories (skip Service)
- âŒ Handlers â†’ Infrastructure (skip layers)
- âŒ Services â†’ Handlers (reverse)
- âŒ Repositories â†’ Services (reverse)

### Domain-Driven Design (DDD) Service Organization

**Services Ä‘Æ°á»£c tá»• chá»©c theo domain:**

```
internal/services/
â”œâ”€â”€ auth/                    # Authentication domain
â”‚   â”œâ”€â”€ service.go          # User management, JWT, API keys
â”‚   â””â”€â”€ repository.go
â”œâ”€â”€ blockchain/             # Blockchain operations domain
â”‚   â”œâ”€â”€ transaction/        # Transaction management
â”‚   â”œâ”€â”€ chaincode/          # Chaincode operations (teaTraceCC, lifecycle)
â”‚   â””â”€â”€ info/               # Block query service
â”œâ”€â”€ analytics/              # Analytics domain
â”‚   â”œâ”€â”€ audit/              # Audit logging (batch writes)
â”‚   â”œâ”€â”€ metrics/            # Metrics collection
â”‚   â””â”€â”€ explorer/           # Block explorer (ready, no endpoints yet)
â”œâ”€â”€ events/                 # Event management domain
â”‚   â”œâ”€â”€ service.go          # Subscriptions, webhooks (async delivery)
â”‚   â””â”€â”€ repository.go
â”œâ”€â”€ authorization/          # Authorization domain
â”‚   â””â”€â”€ service.go          # RBAC/ABAC authorization
â”œâ”€â”€ certificate/            # Certificate management domain
â”‚   â””â”€â”€ service.go          # User certificate management
â”œâ”€â”€ access/                 # Access control domain
â”‚   â””â”€â”€ acl/                # ACL policies & permissions
â””â”€â”€ network/                # Network management domain (ready, no endpoints yet)
    â”œâ”€â”€ discovery/          # Network discovery service
    â””â”€â”€ monitoring/         # Network monitoring service
```

**Service Dependencies:**
- **Independent:** Auth, ACL, Metrics, Audit
- **Gateway-Dependent:** Transaction, Chaincode, Blockchain Info, TeaTrace (via Gateway Client)
- **Database-Dependent:** Transaction, Event, Audit, Metrics, ACL, Authorization, Certificate
- **Orchestration:** Service A cÃ³ thá»ƒ gá»i Service B (nhÆ°ng Handler khÃ´ng Ä‘Æ°á»£c gá»i trá»±c tiáº¿p Service B)

### 1. Handler Pattern (`internal/handlers`)

```go
func (h *Handler) Method(w http.ResponseWriter, r *http.Request) {
    // 1. Parse request & Validate input (utils.ValidateStruct)
    var req RequestModel
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        h.respondError(w, http.StatusBadRequest, "INVALID_REQUEST", "Invalid request body")
        return
    }
    
    if validationErrors := utils.ValidateStruct(&req); validationErrors != nil {
        h.respondError(w, http.StatusBadRequest, "VALIDATION_ERROR", validationErrors)
        return
    }
    
    // 2. Call Service Layer
    result, err := h.service.Method(r.Context(), &req)
    if err != nil {
        h.logger.Error("Operation failed", zap.Error(err))
        h.respondError(w, http.StatusInternalServerError, "INTERNAL_ERROR", "An error occurred")
        return
    }
    
    // 3. Return Response (JSON)
    h.respondSuccess(w, http.StatusOK, result)
}
```

### 2. Service Pattern (`internal/services`)

```go
func (s *Service) Method(ctx context.Context, req *Request) (*Response, error) {
    // 1. Business Logic
    // 2. Call Repository/Gateway
    // 3. Return DTO/Model
    result, err := s.repository.Find(ctx, req.ID)
    if err != nil {
        return nil, fmt.Errorf("failed to find: %w", err)
    }
    return result, nil
}
```

### 3. Repository Pattern (`internal/infrastructure/persistence`)

```go
func (r *Repository) FindUserByEmail(ctx context.Context, email string) (*User, error) {
    // 1. Database query (use sqlc generated code)
    // 2. Map to model
    // 3. Return result
    user, err := r.queries.GetUserByEmail(ctx, email)
    if err != nil {
        return nil, fmt.Errorf("failed to get user: %w", err)
    }
    return user, nil
}
```

**Naming:** Function names pháº£i rÃµ nghÄ©a: `FindUserByEmail`, `CreateTransaction`, `UpdateBatchStatus`

---

## Naming Conventions

- **Variables/Functions:** `camelCase` (private), `PascalCase` (public)
- **Interfaces:** TÃªn interface káº¿t thÃºc báº±ng `er` (náº¿u Ä‘Æ¡n giáº£n) hoáº·c theo domain (e.g., `AuthService`)
- **Handlers:** `{Resource}Handler` (e.g., `AuthHandler`, `TransactionHandler`)
- **Services:** `{Domain}Service` (e.g., `AuthService`, `BlockchainService`)
- **Repositories:** `{Resource}Repository` (e.g., `UserRepository`)
- **Models:** PascalCase (e.g., `User`, `Transaction`)
- **DB Tables:** `snake_case` (e.g., `user_audit_logs`)
- **API Keys:** Prefix `ibn_`

---

## API Design Rules

- **Base path:** `/api/v1`
- **RESTful:** GET (read), POST (create), PUT (update), DELETE (delete)
- **Auth:** JWT Bearer Token hoáº·c API Key header (`X-API-Key`)
- **Response format:** JSON
- **Success:** `{"success": true, "data": {...}}`
- **Error:** `{"error": {"code": "ERROR_CODE", "message": "...", "details": {...}}}`
- **Pagination:** `limit` vÃ  `offset` query parameters

### Idempotency (QUAN TRá»ŒNG cho POST requests)

**POST requests PHáº¢I há»— trá»£ idempotency key:**
- **Header:** `Idempotency-Key: <uuid>` (UUID v4, 36 chars)
- **Storage:** Redis vá»›i TTL 24 hours
- **Key pattern:** `idempotency:{endpoint}:{user_id}:{key}`
- **Behavior:** 
  - First request: Process normally, store response
  - Duplicate request: Return cached response (200 OK, not 201 Created)
- **Validation:** Check Redis before processing

**Example:**
```go
// Handler checks idempotency key
idempotencyKey := r.Header.Get("Idempotency-Key")
if idempotencyKey != "" {
    cached, err := cache.Get(ctx, fmt.Sprintf("idempotency:%s:%s", endpoint, idempotencyKey))
    if err == nil && cached != nil {
        // Return cached response
        return cached
    }
}
```

---

## Error Handling Rules

**Return JSON format chuáº©n cho má»i lá»—i HTTP:**

```json
{
  "error": {
    "code": "ERR_INVALID_INPUT",
    "message": "Chi tiáº¿t lá»—i cho human readable",
    "details": {}
  }
}
```

- **Tuyá»‡t Ä‘á»‘i khÃ´ng** Ä‘á»ƒ lá»™ panic hoáº·c lá»—i raw cá»§a database ra response
- LuÃ´n log errors vá»›i context (zap logger): `logger.Error("Operation failed", zap.Error(err), zap.String("user_id", userID))`
- Return appropriate HTTP status codes (400, 401, 403, 404, 500)

---

## ğŸ› Debugging & Log Analysis Strategy (KHI USER PASTE LOGS)

Khi user cung cáº¥p log lá»—i hoáº·c stack trace, hÃ£y tuÃ¢n thá»§ quy trÃ¬nh sau:

### 1. Security First (ğŸ›¡ï¸ Cáº¢NH BÃO NGAY)

**QUÃ‰T NGAY Láº¬P Tá»¨C** xem log cÃ³ chá»©a sensitive data:
- âŒ API Keys: `ibn_...` (32+ characters sau prefix)
- âŒ Private Keys: `-----BEGIN PRIVATE KEY-----`, `sk_...`
- âŒ Passwords: Connection strings vá»›i `password=...`, `pwd=...`
- âŒ JWT Tokens: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`
- âŒ Database credentials: `postgresql://user:password@host`

**Náº¿u phÃ¡t hiá»‡n:**
- âš ï¸ **Cáº¢NH BÃO USER NGAY Láº¬P Tá»¨C** (in Ä‘áº­m, mÃ u Ä‘á» náº¿u cÃ³ thá»ƒ)
- Äá» nghá»‹ user xÃ³a/revoke credential Ä‘Ã³ ngay
- KhÃ´ng repeat láº¡i sensitive data trong response
- Gá»£i Ã½ cÃ¡ch rotate credentials

### 2. Categorize Error (PhÃ¢n loáº¡i lá»—i theo Layer)

#### A. Fabric/Blockchain Errors
**Keywords:** `MVCC_READ_CONFLICT`, `chaincode execution failed`, `endorsement policy`, `transaction timeout`, `proposal response`, `peer0.org1`

**Action:**
- âŒ **KHÃ”NG** sá»­a code Go vá»™i vÃ ng
- âœ… Kiá»ƒm tra logic transaction trong chaincode
- âœ… Kiá»ƒm tra retry mechanism trong Gateway Client
- âœ… Kiá»ƒm tra Gateway connection (`GATEWAY_BASE_URL`, `GATEWAY_TIMEOUT`)
- âœ… Xem láº¡i transaction sequence vÃ  conflict resolution
- âœ… Kiá»ƒm tra endorsement policy configuration

**Common Fabric Errors:**
- `MVCC_READ_CONFLICT`: Transaction conflict â†’ Implement retry vá»›i exponential backoff
- `ENDORSEMENT_POLICY_FAILURE`: Policy khÃ´ng match â†’ Kiá»ƒm tra chaincode approval
- `chaincode execution failed`: Logic error trong chaincode â†’ Debug chaincode, khÃ´ng pháº£i backend

#### B. Database Errors
**Keywords:** `sql: no rows in result set`, `serialization failure`, `connection refused`, `too many connections`, `deadlock detected`, `pgx`, `postgres`

**Action:**
- âœ… Kiá»ƒm tra connection pool size (pgx/v5, pool 5-25)
- âœ… Kiá»ƒm tra cÃ¢u query sqlc (cÃ³ parameterized khÃ´ng?)
- âœ… Kiá»ƒm tra transaction isolation level
- âœ… Kiá»ƒm tra N+1 queries (loop vÃ  query trong loop)
- âœ… Kiá»ƒm tra missing indexes (slow queries)

**Common DB Errors:**
- `too many connections`: Connection pool exhausted â†’ TÄƒng pool size hoáº·c fix connection leaks
- `serialization failure`: Transaction conflict â†’ Retry transaction
- `no rows in result set`: Expected behavior â†’ Handle vá»›i `errors.Is(err, sql.ErrNoRows)`

#### C. Application/Go Errors
**Keywords:** `panic: runtime error`, `nil pointer dereference`, `index out of range`, `invalid memory address`, `goroutine`, `context deadline exceeded`

**Action:**
- âœ… Chá»‰ ra chÃ­nh xÃ¡c dÃ²ng code gÃ¢y lá»—i (file path + line number)
- âœ… PhÃ¢n tÃ­ch stack trace Ä‘á»ƒ xÃ¡c Ä‘á»‹nh layer (Handler/Service/Repository)
- âœ… Kiá»ƒm tra nil pointer checks
- âœ… Kiá»ƒm tra array/slice bounds
- âœ… Kiá»ƒm tra context timeout/cancellation

**Common Go Errors:**
- `nil pointer dereference`: Missing nil check â†’ ThÃªm validation
- `index out of range`: Array bounds â†’ Validate length trÆ°á»›c khi access
- `context deadline exceeded`: Timeout â†’ TÄƒng timeout hoáº·c optimize query

#### D. Gateway/Network Errors
**Keywords:** `dial tcp`, `connection refused`, `timeout`, `502 Bad Gateway`, `503 Service Unavailable`, `gateway`

**Action:**
- âœ… Kiá»ƒm tra Gateway Client configuration
- âœ… Kiá»ƒm tra network connectivity (Docker network)
- âœ… Kiá»ƒm tra Gateway health (`/health` endpoint)
- âœ… Kiá»ƒm tra timeout settings

### 3. Root Cause Analysis (RCA)

**KHÃ”NG Ä‘Æ°a ra giáº£i phÃ¡p "thá»­ mÃ¹" (blind fix).**

**Pháº£i giáº£i thÃ­ch rÃµ:**
1. **Layer xÃ¡c Ä‘á»‹nh:** "Lá»—i nÃ y xáº£y ra á»Ÿ Layer [Handler/Service/Repository/Infrastructure]"
2. **NguyÃªn nhÃ¢n gá»‘c:** "Do [nguyÃªn nhÃ¢n cá»¥ thá»ƒ]"
3. **Impact:** "áº¢nh hÆ°á»Ÿng Ä‘áº¿n [component/feature nÃ o]"
4. **Timeline:** "Xáº£y ra khi [action/condition nÃ o]"

**Náº¿u log thiáº¿u context:**
- YÃªu cáº§u user cung cáº¥p thÃªm:
  - Log xung quanh (trÆ°á»›c/sau lá»—i)
  - Request ID hoáº·c Transaction ID
  - File code liÃªn quan
  - Environment (dev/staging/prod)
  - Timestamp chÃ­nh xÃ¡c

### 4. Fix Proposal

**LuÃ´n Ä‘á» xuáº¥t fix Ä‘i kÃ¨m:**
1. **Code fix:** Code changes cá»¥ thá»ƒ vá»›i file path vÃ  line numbers
2. **Test case:** CÃ¡ch reproduce lá»—i (náº¿u cÃ³ thá»ƒ)
3. **Prevention:** CÃ¡ch trÃ¡nh lá»—i tÆ°Æ¡ng tá»± trong tÆ°Æ¡ng lai
4. **Monitoring:** Metrics/alerts cáº§n thÃªm Ä‘á»ƒ detect sá»›m

**Format Ä‘á» xuáº¥t:**
```markdown
## Fix Proposal

**File:** `internal/services/blockchain/transaction/service.go:123`

**Issue:** Nil pointer dereference khi Gateway returns nil response

**Fix:**
```go
// Before
result := gatewayResponse.Data

// After
if gatewayResponse == nil || gatewayResponse.Data == nil {
    return nil, fmt.Errorf("gateway returned nil response")
}
result := gatewayResponse.Data
```

**Test:**
- Mock Gateway Client Ä‘á»ƒ return nil response
- Verify error handling

**Prevention:**
- Add nil checks cho táº¥t cáº£ Gateway responses
- Add integration test cho Gateway failure scenarios
```

### 5. Log Pattern Recognition

**Nháº­n diá»‡n cÃ¡c pattern logs phá»• biáº¿n:**

- **Structured Log (zap):** `{"level":"error","msg":"...","error":"...","user_id":"..."}`
  - Parse JSON Ä‘á»ƒ extract fields
  - TÃ¬m correlation ID Ä‘á»ƒ trace request flow

- **Stack Trace:** TÃ¬m `goroutine`, `panic`, `runtime.` Ä‘á»ƒ xÃ¡c Ä‘á»‹nh goroutine leak hoáº·c panic

- **Request Flow:** Trace tá»« Handler â†’ Service â†’ Repository dá»±a trÃªn log messages

---

## Logging

- **Logger:** `go.uber.org/zap` (Structured Log)
- **Log levels:** DEBUG, INFO, WARN, ERROR
- **Include context:** User ID, Request ID, Action, etc.
- **Location:** `internal/utils/logger.go`
- **Audit Logging:** `internal/services/analytics/audit/` (batch writes)

**Example:**
```go
logger.Info("User logged in",
    zap.String("user_id", userID),
    zap.String("email", email),
    zap.Time("timestamp", time.Now()),
)
```

---

## Caching Strategy

**Multi-Layer Caching:**
- **L1:** In-memory cache (5-15 minutes TTL) - Hot data
- **L2:** Redis cache (30 minutes - 1 hour TTL) - User permissions, API keys
- **L3:** Database (persistent)

**Cache Patterns:**
- **Cache-Aside:** User data, permissions
- **Write-Through:** API keys, policies
- **Write-Behind:** Audit logs (batch writes)

---

## Event-Driven Architecture

**Event Service:** `internal/services/events/`

**Event Types:**
- Transaction: `transaction.submitted`, `transaction.committed`, `transaction.failed`
- User: `user.created`, `user.updated`, `user.role.changed`
- Network: `peer.down`, `peer.up`, `channel.created`
- ACL: `policy.created`, `policy.updated`, `permission.granted`

**Event Handlers:**
- **Synchronous:** Cache invalidation, real-time notifications
- **Asynchronous:** Audit logging, metrics aggregation, webhook delivery

**Implementation:**
- Event subscriptions: CRUD operations
- Webhook delivery: Async vá»›i retry mechanism
- WebSocket connections: Real-time events
- Event bus: Ready for Redis Pub/Sub or RabbitMQ integration

---

## Background Workers & Async Processing

**Background Workers Ä‘Ã£ implemented:**
- **Audit Log Batch Writer:** `internal/services/analytics/audit/` (batch writes, graceful shutdown)
- **Metrics Aggregation:** `internal/services/analytics/metrics/` (real-time collection)
- **Transaction Submission:** Async vá»›i goroutines (fire-and-forget)
- **Event Service:** Webhook delivery worker pool

**Pattern:**
```go
// Start background worker
go func() {
    for {
        select {
        case <-ctx.Done():
            return
        case job := <-jobQueue:
            processJob(job)
        }
    }
}()

// Graceful shutdown
defer func() {
    shutdownCtx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    // Wait for workers to finish
}()
```

**Best Practices:**
- âœ… Sá»­ dá»¥ng context vá»›i timeout/cancellation
- âœ… Graceful shutdown (30 seconds timeout)
- âœ… Error handling vÃ  logging
- âŒ KhÃ´ng block request handlers vá»›i long-running operations

---

## Testing Strategy

- **Unit Test:** Table-driven tests (`*_test.go` trong cÃ¹ng package)
- **Mock:** Sá»­ dá»¥ng `mockery` hoáº·c tá»± viáº¿t mock cho external dependencies (Gateway, Redis)
- **Integration:** Test database, Redis, Gateway (use testcontainers)
- **Coverage:** Target >80%
- âŒ **Cáº¤M:** Test vá»›i production database

### ğŸ§¹ Test Lifecycle & Cleanup (QUAN TRá»ŒNG)

#### 1. Regression Testing (Æ¯u tiÃªn - NÃŠN GIá»®)

**Khi fix bug hoáº·c implement feature:**
- âŒ **KHÃ”NG** táº¡o file táº¡m (`debug_main.go`, `temp_test.go`, `test_fix.go`)
- âœ… **PHáº¢I** thÃªm test case má»›i vÃ o file `*_test.go` hiá»‡n cÃ³ trong cÃ¹ng package
- âœ… Test case pháº£i reproduce Ä‘Æ°á»£c bug/feature Ä‘Ã³
- âœ… Má»¥c Ä‘Ã­ch: Giá»¯ láº¡i test case vÄ©nh viá»…n Ä‘á»ƒ ngÄƒn cháº·n regression (lá»—i tÃ¡i diá»…n)

**Example:**
```go
// âœ… ÄÃšNG: ThÃªm vÃ o existing_test.go
func TestService_HandleNilPointer(t *testing.T) {
    // Test case Ä‘á»ƒ reproduce bug #123
    // ...
}

// âŒ SAI: Táº¡o file má»›i
// test_bug_123.go - KHÃ”NG ÄÆ¯á»¢C Táº O FILE Táº M
```

#### 2. Temporary Debug Scripts (NÃŠN XÃ“A)

**Náº¿u báº¯t buá»™c pháº£i táº¡o file script riÃªng Ä‘á»ƒ debug/test thá»§ cÃ´ng:**
- âœ… File pháº£i cÃ³ comment rÃµ rÃ ng á»Ÿ Ä‘áº§u: `// TEMPORARY FILE - DELETE AFTER USE`
- âœ… Äáº·t trong `cmd/debug_*` hoáº·c `scripts/temp_*` Ä‘á»ƒ dá»… nháº­n biáº¿t
- âœ… **Sau khi fix xong:** AI PHáº¢I chá»§ Ä‘á»™ng nháº¯c user:
  - *"TÃ´i Ä‘Ã£ fix xong. Báº¡n cÃ³ muá»‘n tÃ´i xÃ³a file debug táº¡m `cmd/debug_tool/main.go` khÃ´ng?"*
  - Hoáº·c cung cáº¥p lá»‡nh: `rm cmd/debug_tool/main.go`

**Example:**
```go
// TEMPORARY FILE - DELETE AFTER USE
// Purpose: Debug transaction submission issue
// Created: 2025-01-27
// TODO: Remove after issue is resolved
package main

func main() {
    // Debug code here
}
```

#### 3. Cleanup Checklist

**TrÆ°á»›c khi commit hoáº·c káº¿t thÃºc task:**
- [ ] Táº¥t cáº£ test cases Ä‘Ã£ Ä‘Æ°á»£c thÃªm vÃ o `*_test.go` chÃ­nh thá»©c
- [ ] KhÃ´ng cÃ²n file táº¡m (`debug_*.go`, `temp_*.go`, `test_*.go` ngoÃ i `*_test.go`)
- [ ] Náº¿u cÃ³ file táº¡m, Ä‘Ã£ nháº¯c user xÃ³a hoáº·c Ä‘Ã£ xÃ³a
- [ ] Test cases má»›i Ä‘Ã£ pass vÃ  Ä‘Æ°á»£c commit cÃ¹ng vá»›i code fix

---

## Documentation & Comments

- **Swagger:** Update annotations (`@Summary`, `@Param`, etc.) ngay trÃªn handler khi sá»­a API
- **Godoc:** Viáº¿t Godoc cho cÃ¡c exported function
- **Complex logic:** Inline comments
- **API Reference:** `docs/v1.0.1/api-reference.md`
- **No Auto-Markdown:** âŒ KhÃ´ng táº¡o file `.md` má»›i trá»« khi Ä‘Æ°á»£c yÃªu cáº§u rÃµ rÃ ng

---

## Project Structure Map

```
backend/
â”œâ”€â”€ cmd/server/main.go                    # Entry point
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ handlers/                         # HTTP handlers (Presentation Layer)
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ blockchain/
â”‚   â”‚   â”œâ”€â”€ chaincode/
â”‚   â”‚   â”œâ”€â”€ audit/
â”‚   â”‚   â””â”€â”€ metrics/
â”‚   â”œâ”€â”€ services/                         # Business logic (Service Layer)
â”‚   â”‚   â”œâ”€â”€ auth/                         # Authentication domain
â”‚   â”‚   â”œâ”€â”€ blockchain/                   # Blockchain domain
â”‚   â”‚   â”œâ”€â”€ analytics/                    # Analytics domain
â”‚   â”‚   â”œâ”€â”€ events/                       # Event management domain
â”‚   â”‚   â”œâ”€â”€ authorization/                # Authorization domain
â”‚   â”‚   â”œâ”€â”€ certificate/                  # Certificate domain
â”‚   â”‚   â”œâ”€â”€ access/                       # Access control domain
â”‚   â”‚   â””â”€â”€ network/                      # Network domain
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ gateway/                      # Gateway Client (API Gateway â†’ Fabric)
â”‚   â”‚   â”œâ”€â”€ database/                     # Database connection pool
â”‚   â”‚   â””â”€â”€ cache/                        # Multi-layer cache
â”‚   â””â”€â”€ middleware/                       # HTTP middleware (auth, logging)
â””â”€â”€ migrations/                           # SQL migrations (001_, 002_, ...)
```

---

## When Adding New Features

1. **Create migration** náº¿u cáº§n database changes
2. **Add service layer** cho business logic
3. **Add handler** cho HTTP endpoint
4. **Add route** trong router
5. **Add tests** cho new code
6. **Update documentation** (Swagger annotations, API reference)

### Checklist Before Committing
- [ ] All layers follow dependency rules (no skip layers)
- [ ] Input validation implemented
- [ ] Error handling with proper logging
- [ ] No hardcoded secrets or credentials
- [ ] Database queries use parameterized statements (sqlc)
- [ ] Tests written and passing
- [ ] Swagger annotations updated
- [ ] No direct Fabric connection (use Gateway Client)
- [ ] Idempotency key support for POST requests (if applicable)
- [ ] **No new markdown/documentation files created** (trá»« khi Ä‘Æ°á»£c yÃªu cáº§u)

---

## âš ï¸ Anti-Patterns - Cáº¦N TRÃNH

### Architecture Anti-Patterns
- **God Object / Fat Service:** âŒ Service vá»›i quÃ¡ nhiá»u responsibilities â†’ âœ… Split thÃ nh multiple focused services
- **Anemic Domain Model:** âŒ Models chá»‰ lÃ  data containers â†’ âœ… Models cÃ³ behavior vÃ  validation
- **Tight Coupling:** âŒ Services depend trá»±c tiáº¿p vÃ o concrete implementations â†’ âœ… Depend on interfaces, use dependency injection

### Code Smells
- **Long Functions:** âŒ Functions > 50 lines â†’ âœ… Break down thÃ nh smaller functions
- **Deep Nesting:** âŒ Nested if/for > 3 levels â†’ âœ… Use early returns, extract functions
- **Magic Numbers/Strings:** âŒ Hardcoded values: `if status == 3` â†’ âœ… Use constants: `if status == StatusProcessed`
- **Duplicate Code:** âŒ Copy-paste code blocks â†’ âœ… Extract common logic to functions

### Performance Anti-Patterns
- âŒ Block request handler vá»›i long-running operations â†’ âœ… Sá»­ dá»¥ng background workers/goroutines
- âŒ Cache sensitive data quÃ¡ lÃ¢u â†’ âœ… Cache vá»›i appropriate TTL (5-15 min)
- âŒ Goroutine leaks â†’ âœ… Sá»­ dá»¥ng context vá»›i timeout/cancellation

### Code Organization Prohibitions
- âŒ Import packages tá»« `internal/` ra ngoÃ i â†’ âœ… `internal/` chá»‰ Ä‘Æ°á»£c import trong cÃ¹ng module
- âŒ Business logic trong `cmd/` hoáº·c `migrations/` â†’ âœ… Business logic PHáº¢I á»Ÿ `internal/services/`
- âŒ Circular dependencies â†’ âœ… Refactor Ä‘á»ƒ trÃ¡nh circular dependencies

---

## References

- **Backend Architecture:** `docs/v1.0.1/backend.md`
- **API Reference:** `docs/v1.0.1/api-reference.md`
- **Instruction Guide:** `.github/copilot/instruction.md`

---

**Last Updated:** 2025-01-27  
**Version:** 1.0.5 (Added: File Generation & Output Control - Cáº¥m tá»± Ã½ táº¡o file markdown/documentation)
